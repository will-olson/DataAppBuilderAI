# Sigma API Integration Guide

## Table of Contents
1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Authentication](#authentication)
4. [Credential Generation](#credential-generation)
5. [Identifying Sigma IDs](#identifying-sigma-ids)
6. [OAuth Override Tokens](#oauth-override-tokens)
7. [API Endpoints & Base URLs](#api-endpoints--base-urls)
8. [Making API Calls](#making-api-calls)
9. [Rate Limits & Best Practices](#rate-limits--best-practices)
10. [Error Handling](#error-handling)
11. [Common Use Cases](#common-use-cases)
12. [Security Considerations](#security-considerations)
13. [Development Resources](#development-resources)
14. [Implementation Checklist](#implementation-checklist)

## Overview

The Sigma REST API provides programmatic access to Sigma's powerful analytics platform, enabling you to:

- **User Management**: Onboard/offboard users, manage account types and permissions
- **Data Operations**: Export data from workbooks, materialize data elements
- **Security**: Manage user attributes for row-level security
- **Administration**: Identify input tables, manage workbook permissions
- **Integration**: Build custom workflows and automated processes

The API follows REST principles with OpenAPI specification, using predictable resource-oriented URLs and standard HTTP response codes.

## Prerequisites

Before integrating with the Sigma API, ensure you have:

1. **API Base URL** - Determined by your cloud hosting provider
2. **API Credentials** - Client ID and secret (generated by you or organization admin)
3. **Bearer Token** - Generated using your credentials
4. **Access Permissions** - Proper role assignments for API operations
5. **Admin Account Type** - Required to generate API client credentials

## Authentication

### Token Generation
- **Endpoint**: `/v2/auth/token`
- **Method**: POST
- **Token Expiry**: 1 hour
- **Rate Limit**: 1 request per second

### Authentication Flow
1. Use your client ID and secret to authenticate
2. Receive a bearer token valid for 1 hour
3. Include token in Authorization header: `Authorization: Bearer <token>`
4. Refresh token before expiry or handle 401 responses

## Credential Generation

### Requirements
- **Account Type**: Must have Admin account type assigned
- **Access**: Developer Access permissions in Administration panel
- **Security**: Credentials are associated with specific organization members

### Step-by-Step Process

1. **Navigate to Administration**
   - From Sigma Home, open Administration
   - Or click user avatar → Administration

2. **Access Developer Access**
   - In the side panel, select "Developer Access"
   - Note your API base URL displayed at the top

3. **Create New Credentials**
   - Click "Create new" button
   - Select "REST API" checkbox for scopes
   - Enter unique name (e.g., "Web app service account credentials")
   - Add optional description
   - Select owner member (determines permission level)

4. **Store Credentials Securely**
   - Copy client ID and secret immediately
   - **⚠️ Important**: Client secret cannot be viewed again after closing dialog
   - Store securely for future reference

### Security Considerations
- **Permission Matching**: Don't share Admin-level credentials with lower-permission users
- **Credential Revocation**: Can revoke at any time; update all applications when revoked
- **Owner Selection**: Choose owner with appropriate permission level for intended use

## Identifying Sigma IDs

Many API endpoints require unique identifiers for target objects. Understanding how to find these IDs is crucial for successful integration.

### Requirements
- **Organization and Member IDs**: Only accessible through API with proper authentication
- **Other IDs**: Can be found either in Sigma UI or via API
- **Permissions**: User must have access to the requested data

### Connection ID
**⚠️ Important**: Use the **long version** of the connection ID for API calls.

#### Via API
- Call the `List connections` endpoint for complete list with IDs
- API returns long version of UUID

#### Via Sigma UI
1. Open Administration → Connections
2. Select target connection
3. Extract ID from URL: `https://app.sigmacomputing.com/<company-url>/s/<connection-name>-<connection-id>`

**Example URL**: `https://app.sigmacomputing.com/my-company/s/Connection-Root-1f8e9847-c7o5-41Te-93b0-b80bPyyf9730`

### Organization ID
- **Via API**: Call `Get current user` endpoint
- **Via Sigma UI**: Cannot be identified directly

### Workspace ID
#### Via API
- Call `List workspaces` endpoint
- API returns long version of UUID
- Both short and long versions work for API calls

#### Via Sigma UI
1. Go to Workspaces
2. Click More → Open for target workspace
3. Extract ID from URL: `https://app.sigmacomputing.com/<company-url>/s/<workspace-name>-<workspace-id>`

**Example URL**: `https://app.sigmacomputing.com/my-company/s/eng-team-1mS1ndDmvcE7MivbcCVbhv`

### Dataset ID
#### Via API
- Call `List datasets` endpoint

#### Via Sigma UI
1. Open target dataset
2. Extract ID from URL: `https://app.sigmacomputing.com/<company-url>/b/<dataset-name>-<dataset-id>/...`

**Example URL**: `https://app.sigmacomputing.com/my-company/b/Salesforce-Campaigns-23PiCBrgchwHc3g323Ai`

### Workbook ID
#### Via API
- Call `List workbooks` endpoint

#### Via Sigma UI
1. Open target workbook
2. Extract ID from URL: `https://app.sigmacomputing.com/<company-url>/workbook/<workbook-name>-<workbook-id>?...`

**Example URL**: `https://app.sigmacomputing.com/my-company/workbook/My-Workbook-7sYWojYnccxJqdqkNKAw6S?:draftId=72c0acd6-4803-4766-b322-7dd05c4a445d`

### Workbook Element ID
#### Via API
1. Find workbook ID
2. Call `List workbook pages for a workbook` endpoint
3. Call `List elements in a workbook page` endpoint

#### Via Sigma UI
1. Open workbook and select element
2. Extract element ID from URL as `nodeId`: `https://app.sigmacomputing.com/<company-url>/workbook/<workbook-name>-<workbook-id>?:nodeId=<element-id>`

**Example URL**: `https://app.sigmacomputing.com/my-company/workbook/My-Workbook-7sYWojYnccxJqdqkNKAw6S?:nodeId=Mkaex5leIGcjlkQa5PqEw`

### Member ID
#### Via API
- **Current User**: Call `Get current user` endpoint
- **All Members**: Call `Get all members` endpoint

#### Via Sigma UI
- Cannot be identified within Sigma application

### Team ID
#### Via API
- Call `List teams` endpoint

#### Via Sigma UI
1. Open Admin Portal → Teams
2. Select target team
3. Extract ID from URL: `https://app.sigmacomputing.com/<company-url>/admin/teams/<team-id>`

**Example URL**: `https://app.sigmacomputing.com/my-company/admin/teams/87659652-5289-4225-95cQ-4b75T3268bEn`

## OAuth Override Tokens

OAuth override tokens allow temporary use of another user's OAuth permissions for API calls, enabling fine-grained access to cloud data warehouse (CDW) data.

### Use Cases
- **Permission Separation**: Manage workbook access and CDW access separately
- **Constrained Access**: Limit API access while maintaining data permissions
- **Data Export**: Export workbooks using connections the API user doesn't have access to

### Requirements
- **OAuth Setup**: Must use OAuth for Sigma-CDW permissioning
- **Access Tokens**: Obtain OAuth access tokens from identity provider
- **Connection IDs**: Use `List connections` endpoint to get connection IDs

### Implementation

#### Header Configuration
```bash
x-sigma-oauth-overrides: [{"conn_id":"connection-id-1", "token":"{oauth_token}"},{"conn_id":"connection-id-2", "token":"{oauth_token}"}]
x-sigma-oauth-reject-default-tokens: true
```

#### cURL Example
```bash
curl --location 'https://api.sigmacomputing.com/v2/workbooks/{workbookId}/export' \
--header 'Content-Type: application/json' \
--header 'Accept: application/json' \
--header 'x-sigma-oauth-overrides: [{"conn_id":"connection-id-1", "token":"{oauth_token}"},{"conn_id":"connection-id-2", "token":"{oauth_token}"}]' \
--header 'x-sigma-oauth-reject-default-tokens: true' \
--header 'Authorization: Bearer {your_token}'
```

#### Python Example
```python
import requests
import json

url = "https://api.sigmacomputing.com/v2/workbooks/{workbookId}/export"

payload = json.dumps({
    "format": {
        "type": "pdf",
        "layout": "portrait"
    }
})

headers = {
    'Content-Type': 'application/json',
    'Accept': 'application/json',
    'x-sigma-oauth-overrides': '[{"conn_id":"connection-id-1", "token":"{oauthToken}"},{"conn_id":"connection-id-2", "token":"{oauthToken}"}]',
    'x-sigma-oauth-reject-default-tokens': 'true',
    'Authorization': 'Bearer {your_token}'
}

response = requests.request("POST", url, headers=headers, data=payload)
```

#### JavaScript Example
```javascript
const myHeaders = new Headers();
myHeaders.append("Content-Type", "application/json");
myHeaders.append("Accept", "application/json");
myHeaders.append("x-sigma-oauth-overrides", "[{\"conn_id\":\"connection-id-1\", \"token\":\"{oauthtoken}\"},{\"conn_id\":\"connection-id-2\", \"token\":\"{oauthToken}\"}]");
myHeaders.append("x-sigma-oauth-reject-default-tokens", "true");
myHeaders.append("Authorization", "Bearer {your_token}");

const raw = JSON.stringify({
    "format": {
        "type": "pdf",
        "layout": "portrait"
    }
});

const requestOptions = {
    method: "POST",
    headers: myHeaders,
    body: raw,
    redirect: "follow"
};

fetch("https://api.sigmacomputing.com/v2/workbooks/{workbookId}/export", requestOptions)
    .then((response) => response.text())
    .then((result) => console.log(result))
    .catch((error) => console.error(error));
```

### Default Token Behavior

The `x-sigma-oauth-reject-default-tokens` header controls fallback behavior:

- **Not Set or `false`**: Uses API user's OAuth token for connections without override tokens
- **Set to `true`**: Rejects default tokens, exports fail if override tokens aren't provided for all connections

### Limitations

OAuth override tokens **do not work** for:
- `List SQL queries in a workbook`
- `Get the SQL query for a workbook element`

**Only affects** endpoints that retrieve data from the data platform. **No effect** on metadata and Sigma app management endpoints like:
- `List members`
- `List grants`
- `Get users for a user attribute`
- `Get tags`

## API Endpoints & Base URLs

### Cloud Provider Mapping

| Provider | Base URL | Token Endpoint |
|----------|----------|----------------|
| **AWS-US (West)** | `https://aws-api.sigmacomputing.com` | `/v2/auth/token` |
| **AWS-US (East)** | `https://api.us-a.aws.sigmacomputing.com` | `/v2/auth/token` |
| **AWS-CA** | `https://api.ca.aws.sigmacomputing.com` | `/v2/auth/token` |
| **AWS-EU** | `https://api.eu.aws.sigmacomputing.com` | `/v2/auth/token` |
| **AWS-UK** | `https://api.uk.aws.sigmacomputing.com` | `/v2/auth/token` |
| **AWS-AU** | `https://api.au.aws.sigmacomputing.com` | `/v2/auth/token` |
| **Azure-US** | `https://api.us.azure.sigmacomputing.com` | `/v2/auth/token` |
| **Azure-EU** | `https://api.eu.azure.sigmacomputing.com` | `/v2/auth/token` |
| **Azure-CA** | `https://api.ca.azure.sigmacomputing.com` | `/v2/auth/token` |
| **Azure-UK** | `https://api.uk.azure.sigmacomputing.com` | `/v2/auth/token` |
| **GCP** | `https://api.sigmacomputing.com` | `/v2/auth/token` |

### Finding Your Base URL
1. **Administration Panel**: Go to `Administration > Developer Access > API base URL`
2. **Account Settings**: Check `Account > General Settings > Site > Cloud`

## Making API Calls

### Supported Methods
- **cURL** from command line
- **Postman** or other API clients
- **Custom scripts** in your preferred language
- **Web interface** of REST API documentation

### Request Format
- **Content-Type**: `application/json`
- **Body**: JSON format
- **Authentication**: Bearer token in Authorization header

### Response Formats
- **Data Export**: CSV, XLSX, PDF, PNG, JSON
- **Standard API**: JSON responses
- **File Downloads**: Binary data for exported files

## Rate Limits & Best Practices

### API Limits
- **Token Generation**: 1 request per second
- **Daily Requests**: No enforced limit
- **Pagination**: 
  - Default page size: 50
  - Maximum page size: 1000

### Best Practices
1. **Token Management**: Implement token refresh logic
2. **Rate Limiting**: Respect 1 req/sec limit for auth
3. **Pagination**: Use appropriate page sizes for large datasets
4. **Error Handling**: Implement exponential backoff for retries
5. **Monitoring**: Track API usage and response times

## Error Handling

### Common Error Responses

#### 401 Unauthorized
```json
{
    "requestId": "2da86966-9666-48e6-b100-ea47a8d9fdbe",
    "message": "We cannot verify your identity. Please try again later.",
    "code": "unauthorized"
}
```

**Causes & Solutions**:
- **Expired Token**: Refresh or regenerate token
- **Invalid Credentials**: Verify client ID and secret
- **IP Restrictions**: Check admin-configured IP allowlist

### Error Handling Strategies
1. **Token Refresh**: Automatic retry with new token
2. **Exponential Backoff**: Progressive delay for retries
3. **Request ID Tracking**: Log request IDs for debugging
4. **Graceful Degradation**: Fallback behavior for API failures

## Common Use Cases

### 1. User Management
```bash
# Onboard new user
POST /users
{
    "email": "user@company.com",
    "firstName": "John",
    "lastName": "Doe",
    "role": "viewer"
}

# Update user permissions
PUT /users/{userId}/permissions
{
    "workbookAccess": ["read", "write"],
    "dataAccess": "restricted"
}
```

### 2. Data Export
```bash
# Export workbook data
POST /workbooks/{workbookId}/export
{
    "format": "csv",
    "filters": {
        "dateRange": "last_30_days"
    }
}

# Download exported file
GET /exports/{exportId}/download
```

### 3. Workbook Management
```bash
# List workbooks
GET /workbooks?page=1&size=50

# Get workbook details
GET /workbooks/{workbookId}

# Update workbook permissions
PUT /workbooks/{workbookId}/permissions
```

## Security Considerations

### API Key Security
- **Never expose** API keys in client-side code
- **Use environment variables** for sensitive credentials
- **Implement IP restrictions** for additional security
- **Rotate credentials** regularly

### CORS Support
- API supports cross-origin resource sharing
- Secure client-side applications can interact with API
- Maintain security by keeping credentials server-side

### Row-Level Security
- Manage user attributes for data access control
- Implement proper permission hierarchies
- Audit access patterns and permissions

## Development Resources

### Official Resources
- **API Documentation**: Built-in web interface for testing
- **OpenAPI Specification**: Downloadable API definition
- **Postman Collection**: QuickStart guide available
- **API Recipes**: Common use case examples

### Code Examples
- **GitHub Repository**: Sample code and scripts
- **Multiple Languages**: Node.js, Ruby, Python, and more
- **Integration Patterns**: Common workflow examples

### Support
- **Sigma Support**: Direct assistance for API issues
- **Community Resources**: Developer forums and discussions
- **Documentation Updates**: Regular API improvements

## Implementation Checklist

### Setup Phase
- [ ] Identify cloud provider and base URL
- [ ] Generate API credentials (client ID + secret)
- [ ] Test authentication and token generation
- [ ] Verify API access permissions

### Development Phase
- [ ] Implement token management system
- [ ] Build error handling and retry logic
- [ ] Create API client wrapper/abstraction
- [ ] Implement rate limiting and pagination

### Testing Phase
- [ ] Test all target endpoints
- [ ] Validate error handling scenarios
- [ ] Performance testing with rate limits
- [ ] Security testing for credential exposure

### Production Phase
- [ ] Monitor API usage and performance
- [ ] Implement logging and alerting
- [ ] Set up credential rotation process
- [ ] Document integration patterns

---

*This guide provides a foundation for building robust Sigma API integrations. For specific implementation details, refer to the official Sigma API documentation and consider your organization's specific requirements and security policies.* 